<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interactive Trello-Style Board</title>
<style>
  :root { --bg:#0b1020; --panel:#111833; --muted:#2a345d; --text:#e8ecff; --sub:#a9b4e6; --accent:#7aa2ff; --green:#34d399; --amber:#f59e0b; --red:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1430);color:var(--text);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial}
  header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(1.1) blur(8px);background:rgba(11,16,32,.8);border-bottom:1px solid #1b2447}
  .toolbar{display:flex;gap:.75rem;align-items:center;justify-content:space-between;max-width:1400px;margin:0 auto;padding:.7rem 1rem}
  .left, .right{display:flex;gap:.5rem;align-items:center}
  h1{font-weight:700;font-size:1.1rem;margin:0;color:#dbe5ff}
  .btn{appearance:none;border:1px solid #2b3768;background:#151f42;color:var(--text);padding:.5rem .7rem;border-radius:.7rem;cursor:pointer;transition:.2s;box-shadow:0 0 0 0 rgba(0,0,0,0)}
  .btn:hover{transform:translateY(-1px);border-color:#3a4a8a}
  .btn.primary{background:linear-gradient(180deg,#1d2b63,#162254);border-color:#3d56aa}
  .btn.ghost{background:transparent;border-color:#25305f}
  .pill{font-size:.85rem;padding:.25rem .5rem;border-radius:999px;border:1px solid #2b3768;color:#cfd7ff}
  .grid{max-width:1400px;margin:1rem auto;padding:0 1rem 3rem 1rem;display:flex;flex-direction:column;gap:1rem}
  .lane{background:rgba(21,31,66,.55);border:1px solid #1e2a56;border-radius:1rem;overflow:hidden}
  .lane-head{display:flex;align-items:center;gap:.6rem;padding:.7rem 1rem;background:rgba(18,26,54,.8);border-bottom:1px solid #1c2550}
  .lane-title{font-weight:700}
  .lane-actions{margin-left:auto;display:flex;gap:.4rem}

  .board{display:grid;grid-template-columns:repeat(4, minmax(230px,1fr));gap:.75rem;padding:1rem;overflow:auto}
  .col{background:#0f1738;border:1px dashed #283467;border-radius:.8rem;padding:.6rem;min-height:140px}
  .col h3{margin:.1rem 0 .5rem 0;font-size:.95rem;color:#c6d2ff}
  .col[data-col="backlog"] h3{color:#a5b4fc}
  .col[data-col="todo"] h3{color:#7dd3fc}
  .col[data-col="doing"] h3{color:#fde68a}
  .col[data-col="done"] h3{color:#bbf7d0}

  .card{background:#121a3d;border:1px solid #2a3974;border-radius:.7rem;padding:.6rem;margin:.5rem 0;display:flex;flex-direction:column;gap:.35rem;cursor:grab}
  .card.dragging{opacity:.6}
  .card .title{font-weight:600}
  .meta{font-size:.8rem;color:var(--sub)}
  .ac{margin-top:.25rem;border-top:1px dashed #2b3768;padding-top:.35rem}
  .ac-item{display:flex;gap:.45rem;align-items:flex-start;margin:.25rem 0}
  .tri{width:18px;height:18px;border-radius:.35rem;border:1px solid #34417a;background:#0e1634;display:inline-grid;place-items:center;cursor:pointer;flex:0 0 18px}
  .tri.partial{outline:2px solid var(--amber);outline-offset:-2px}
  .tri.complete{background:linear-gradient(180deg,#1b3b2f,#0f2d24);border-color:#1f6b54}
  .tri.complete::after{content:"âœ“";font-size:.8rem;color:#7ef7c8}
  .tri.partial::after{content:"â€“";font-size:1rem;line-height:1;color:#fde68a}
  .ac-text{flex:1}

  .card-actions{display:flex;gap:.35rem;margin-top:.25rem}
  .icon-btn{border:1px solid #2b3768;background:#0c1330;border-radius:.5rem;padding:.25rem .4rem;cursor:pointer;font-size:.85rem;color:#cbd6ff}
  .icon-btn:hover{border-color:#3f51a6}
  .badge{font-size:.7rem;border:1px solid #2b3768;border-radius:.4rem;padding:.05rem .35rem;color:#aab6f1}

  .empty{opacity:.6;font-size:.9rem;padding:.3rem 0}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,8,20,.6);z-index:10}
  .modal.open{display:flex}
  .dialog{background:#0e1636;border:1px solid #213071;border-radius:1rem;min-width:300px;max-width:560px;width:92%;padding:1rem}
  .dialog h2{margin:.2rem 0 1rem 0}
  .field{display:flex;flex-direction:column;margin:.5rem 0}
  .field label{font-size:.85rem;color:#c4cffc;margin-bottom:.25rem}
  .field input, .field textarea, .field select{background:#0b1230;border:1px solid #2a3870;color:#e8ecff;border-radius:.6rem;padding:.5rem}
  .field textarea{min-height:90px}
  .row{display:flex;gap:.5rem;flex-wrap:wrap}
  .danger{color:#fecaca;border-color:#ef4444;background:#2a0f1a}

  .hint{font-size:.8rem;color:#9fb0ff}
  .footer{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.7rem}

  .toast{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:#0e1636;border:1px solid #2b3768;color:#dbe4ff;border-radius:.7rem;padding:.5rem .8rem;display:none;z-index:11}
  .toast.show{display:block}

  @media (max-width: 900px){
    .board{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <header>
    <div class="toolbar">
      <div class="left">
        <h1>Project Board</h1>
        <span class="pill" id="stats"></span>
      </div>
      <div class="right">
        <button class="btn ghost" id="importMdBtn">Import project.md</button>
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn primary" id="addEpicBtn">+ Epic</button>
      </div>
    </div>
  </header>

  <main class="grid" id="grid"></main>

  <div class="modal" id="modal">
    <div class="dialog" role="dialog" aria-modal="true">
      <h2 id="modalTitle">Edit</h2>
      <div id="modalBody"></div>
      <div class="footer">
        <button class="btn ghost" id="cancelModal">Cancel</button>
        <button class="btn primary" id="okModal">OK</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
// ====== Initial data injected from parsed project.md ======
const initialData = (() => {
  // The JSON below will be replaced by the assistant with parsed data
  return [{"id":"epic-1","title":"Epic 1: Core Recording & Processing Workflow","stories":[{"id":"story-1","title":"User Story 1.1: Recording Type Selection","as_a":"teacher","i_want":"choose between different recording types (Note, Assessment, Review)","so_that":"I can create the appropriate type of feedback for my needs","acceptance":[{"text":"Display three clear recording type options with descriptions","status":"blank"},{"text":"Show recording tips and guidance for each type","status":"blank"},{"text":"Allow navigation back to recordings overview","status":"blank"},{"text":"Provide visual indicators for each recording type (icons, colors)","status":"blank"},{"text":"Include estimated recording time recommendations (2-5 minutes)","status":"blank"}]},{"id":"story-2","title":"User Story 1.2: Audio Recording Interface","as_a":"teacher","i_want":"record audio with clear visual feedback (levels, duration)","so_that":"my recording is reliable and easy to manage","acceptance":[{"text":"Record, pause, resume, and stop controls","status":"blank"},{"text":"Waveform or level meter indicating input volume","status":"blank"},{"text":"Timer showing elapsed time","status":"blank"},{"text":"Error handling for microphone permissions and failures","status":"blank"},{"text":"Option to discard or save recording","status":"blank"}]},{"id":"story-3","title":"User Story 1.3: Local Storage of Recordings","as_a":"teacher","i_want":"store recordings locally by default","so_that":"privacy is preserved and I retain control of data","acceptance":[{"text":"Save audio files to IndexedDB or browser storage","status":"blank"},{"text":"List saved recordings with timestamps and size","status":"blank"},{"text":"Delete and rename recordings","status":"blank"},{"text":"No default upload to server","status":"blank"}]},{"id":"story-4","title":"User Story 1.4: Transcription","as_a":"teacher","i_want":"transcribe recorded audio","so_that":"I can read and edit the text of my recording","acceptance":[{"text":"Transcribe using configured backend API","status":"blank"},{"text":"Show editable transcript with basic text tools","status":"blank"},{"text":"Indicate transcription confidence or segments","status":"blank"},{"text":"Handle long recordings gracefully (timeouts, chunks)","status":"blank"}]},{"id":"story-5","title":"User Story 1.5: Privacy Controls","as_a":"teacher","i_want":"clear privacy and storage controls","so_that":"I can capture my thoughts effectively","acceptance":[{"text":"Switch between local-only and cloud processing where available","status":"blank"},{"text":"No retention of audio by default","status":"blank"},{"text":"Clear explainers for data handling","status":"blank"}]}]},{"id":"epic-2","title":"Epic 2: AI-Powered Content Generation","stories":[{"id":"story-6","title":"User Story 2.1: Student Note Draft","as_a":"teacher","i_want":"generate a concise student-facing note","so_that":"students understand next steps","acceptance":[{"text":"Generate compassionate, age-appropriate note","status":"blank"},{"text":"Include 1â€“3 specific strengths","status":"blank"},{"text":"Include 1â€“3 specific actionable next steps","status":"blank"},{"text":"Keep within configurable character limit","status":"blank"}]},{"id":"story-7","title":"User Story 2.2: Assessment Memo","as_a":"teacher","i_want":"create an internal assessment memo","so_that":"I can track evaluation details","acceptance":[{"text":"Include rubric-like breakdown (criteria, evidence, level)","status":"blank"},{"text":"Supports subject-specific terminology","status":"blank"},{"text":"Editable sections and export to PDF","status":"blank"}]},{"id":"story-8","title":"User Story 2.3: Progress Review","as_a":"teacher","i_want":"summarize progress over time","so_that":"I can prepare for development talks","acceptance":[{"text":"Aggregate notes and assessments across date range","status":"blank"},{"text":"Show trends and key themes","status":"blank"},{"text":"Export as parent-friendly summary","status":"blank"}]},{"id":"story-9","title":"User Story 2.4: Tone and Grade Bands","as_a":"teacher","i_want":"configure tone and grade band","so_that":"outputs fit the audience","acceptance":[{"text":"Select grade band (1â€“4, 5â€“8, 9â€“12)","status":"blank"},{"text":"Switch tone presets (warm, neutral, formal)","status":"blank"},{"text":"Preview before finalizing","status":"blank"}]}]},{"id":"epic-3","title":"Epic 3: Templates & Routines","stories":[{"id":"story-10","title":"User Story 3.1: Recording Templates","as_a":"teacher","i_want":"templates for common scenarios","so_that":"I record consistently","acceptance":[{"text":"Provide scenario templates with prompts","status":"blank"},{"text":"Allow customization and saving","status":"blank"},{"text":"Template selection before recording","status":"blank"}]},{"id":"story-11","title":"User Story 3.2: Routine Builder","as_a":"teacher","i_want":"set weekly routines","so_that":"I keep feedback cadence","acceptance":[{"text":"Create routine with title, days, targets","status":"blank"},{"text":"Reminders and checklists","status":"blank"},{"text":"Track completion","status":"blank"}]}]},{"id":"epic-4","title":"Epic 4: UI/UX & Accessibility","stories":[{"id":"story-12","title":"User Story 4.1: Accessible Recording UI","as_a":"teacher","i_want":"WCAG-compliant flows","so_that":"app is usable by all","acceptance":[{"text":"Keyboard navigation and ARIA labels","status":"blank"},{"text":"High-contrast mode","status":"blank"},{"text":"Screen-reader friendly controls","status":"blank"}]},{"id":"story-13","title":"User Story 4.2: Mobile First","as_a":"teacher","i_want":"great mobile UX","so_that":"I can capture on the go","acceptance":[{"text":"Responsive layouts for small screens","status":"blank"},{"text":"Touch-friendly controls","status":"blank"},{"text":"Offline-friendly interactions","status":"blank"}]}]},{"id":"epic-5","title":"Epic 5: Data Management & Export","stories":[{"id":"story-14","title":"User Story 5.1: Export Options","as_a":"teacher","i_want":"export notes and memos","so_that":"I can share and archive","acceptance":[{"text":"Export to PDF/Docx/Markdown","status":"blank"},{"text":"Include anonymization toggle","status":"blank"},{"text":"Batch export by date range","status":"blank"}]},{"id":"story-15","title":"User Story 5.2: Tagging & Search","as_a":"teacher","i_want":"tag entries and search","so_that":"I can find information quickly","acceptance":[{"text":"Multi-tag per entry","status":"blank"},{"text":"Full-text search across transcripts","status":"blank"},{"text":"Saved filters","status":"blank"}]}]},{"id":"epic-6","title":"Epic 6: Security & Privacy Settings","stories":[{"id":"story-16","title":"User Story 6.1: Consent & Policy","as_a":"teacher","i_want":"clear consent settings","so_that":"I comply with rules","acceptance":[{"text":"Consent banner and settings page","status":"blank"},{"text":"Granular toggles for data sharing","status":"blank"},{"text":"Audit log for exports","status":"blank"}]}]},{"id":"epic-7","title":"Epic 7: Admin & Org","stories":[{"id":"story-17","title":"User Story 7.1: School Onboarding","as_a":"admin","i_want":"onboard school accounts","so_that":"teachers can start quickly","acceptance":[{"text":"Invite via email links","status":"blank"},{"text":"Role-based permissions","status":"blank"},{"text":"Bulk import of classes","status":"blank"}]}]},{"id":"epic-8","title":"Epic 8: Observational Tools","stories":[{"id":"story-18","title":"User Story 8.1: Structured Observation","as_a":"teacher","i_want":"log observations quickly","so_that":"I capture patterns","acceptance":[{"text":"Tap-to-tag behaviors and contexts","status":"blank"},{"text":"Time-stamped entries","status":"blank"},{"text":"Export to progress review","status":"blank"}]}]},{"id":"epic-9","title":"Epic 9: Integrations","stories":[{"id":"story-19","title":"User Story 9.1: LMS Export","as_a":"teacher","i_want":"send results to LMS","so_that":"I avoid duplicate work","acceptance":[{"text":"Integrate with Google Classroom/Teams","status":"blank"},{"text":"Consent-aware data mapping","status":"blank"},{"text":"Error handling and retries","status":"blank"}]}]},{"id":"epic-10","title":"Epic 10: Quality & Review","stories":[{"id":"story-20","title":"User Story 10.1: Human-in-the-Loop","as_a":"teacher","i_want":"approve AI outputs","so_that":"quality is ensured","acceptance":[{"text":"Edit before finalizing","status":"blank"},{"text":"Track manual edits","status":"blank"},{"text":"Flag low-confidence segments","status":"blank"}]}]},{"id":"epic-11","title":"Epic 11: Feedback & Analytics","stories":[{"id":"story-21","title":"User Story 11.1: Usage Dashboard","as_a":"admin","i_want":"see usage metrics","so_that":"I can support adoption","acceptance":[{"text":"Daily/weekly usage charts","status":"blank"},{"text":"Top templates and features","status":"blank"},{"text":"Export CSV","status":"blank"}]}]},{"id":"epic-12","title":"Epic 12: Support & Help","stories":[{"id":"story-22","title":"User Story 12.1: In-App Help","as_a":"teacher","i_want":"helpful guides","so_that":"I can self-serve","acceptance":[{"text":"Contextual tooltips and walkthroughs","status":"blank"},{"text":"Searchable help center","status":"blank"},{"text":"Contact support link","status":"blank"}]}]}];
})();

// Normalize into swimlanes with default columns
const defaultColumns = ["backlog","todo","doing","done"];
function seedState(epics){
  return epics.map(e => ({
    id: e.id,
    title: e.title,
    columns: {
      backlog: e.stories.map(s => makeCardFromStory(s)),
      todo: [], doing: [], done: []
    }
  }));
}

function makeCardFromStory(s){
  return {
    id: s.id,
    title: s.title || "Untitled Story",
    as_a: (s.as_a||'').trim(),
    i_want: (s.i_want||'').trim(),
    so_that: (s.so_that||'').trim(),
    acceptance: (s.acceptance||[]).map(a=>({text:a.text, status:a.status||'blank'}))
  };
}

// ---- Persistence ----
const LS_KEY = 'trello_board_state_v1';
let state = load() || seedState(initialData);

function load(){
  try{ const j = localStorage.getItem(LS_KEY); return j? JSON.parse(j): null }catch(e){ return null }
}
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); toast('Saved'); render(); }

// ---- Rendering ----
const grid = document.getElementById('grid');
const stats = document.getElementById('stats');
function render(){
  // stats
  const storyCount = state.reduce((n,l)=> n + defaultColumns.reduce((a,c)=>a+l.columns[c].length,0),0);
  stats.textContent = `${state.length} epics â€¢ ${storyCount} stories`;

  grid.innerHTML = '';
  state.forEach(lane => {
    const laneEl = document.createElement('section'); laneEl.className='lane'; laneEl.dataset.laneId = lane.id;
    laneEl.innerHTML = `
      <div class="lane-head">
        <div class="lane-title">${escapeHtml(lane.title)}</div>
        <span class="badge">${lane.columns.backlog.length} backlog</span>
        <span class="badge">${lane.columns.todo.length} todo</span>
        <span class="badge">${lane.columns.doing.length} doing</span>
        <span class="badge">${lane.columns.done.length} done</span>
        <div class="lane-actions">
          <button class="icon-btn" title="Add story" data-act="add-story">ï¼‹ Story</button>
          <button class="icon-btn" title="Rename epic" data-act="rename-epic">âœŽ</button>
          <button class="icon-btn danger" title="Delete epic" data-act="delete-epic">ðŸ—‘</button>
        </div>
      </div>`;

    const board = document.createElement('div'); board.className='board';
    defaultColumns.forEach(colId => {
      const col = document.createElement('div'); col.className='col'; col.dataset.col = colId; col.dataset.laneId = lane.id; col.innerHTML = `<h3>${colLabel(colId)}</h3>`;

      const cards = lane.columns[colId];
      if(cards.length===0){
        const em = document.createElement('div'); em.className='empty'; em.textContent='â€” empty â€”'; col.appendChild(em);
      } else {
        cards.forEach(card => col.appendChild(renderCard(card, lane.id, colId)));
      }

      // drag & drop events on column
      col.addEventListener('dragover', (e)=>{ e.preventDefault(); col.style.outline='2px dashed #4c6fff' });
      col.addEventListener('dragleave', ()=>{ col.style.outline='none' });
      col.addEventListener('drop', (e)=>{
        col.style.outline='none';
        const payload = JSON.parse(e.dataTransfer.getData('text/plain'));
        handleDrop(payload, lane.id, colId);
      });

      board.appendChild(col);
    });

    laneEl.appendChild(board);

    // Lane actions
    laneEl.querySelector('[data-act="add-story"]').onclick = ()=> openStoryModal({ laneId: lane.id });
    laneEl.querySelector('[data-act="rename-epic"]').onclick = ()=> openEpicModal(lane.id);
    laneEl.querySelector('[data-act="delete-epic"]').onclick = ()=> deleteEpic(lane.id);

    grid.appendChild(laneEl);
  });
}

function renderCard(card, laneId, colId){
  const el = document.createElement('article'); el.className='card'; el.draggable=true; el.dataset.cardId=card.id; el.dataset.laneId=laneId; el.dataset.colId=colId;
  el.addEventListener('dragstart', (e)=>{
    el.classList.add('dragging');
    e.dataTransfer.setData('text/plain', JSON.stringify({cardId: card.id, fromLane: laneId, fromCol: colId}));
  });
  el.addEventListener('dragend', ()=> el.classList.remove('dragging'));

  const acCount = card.acceptance.length;
  const acComplete = card.acceptance.filter(a=>a.status==='complete').length;

  el.innerHTML = `
    <div class="title">${escapeHtml(card.title)}</div>
    <div class="meta">As a ${escapeHtml(card.as_a||'â€”')}, I want to ${escapeHtml(card.i_want||'â€”')} so that ${escapeHtml(card.so_that||'â€”')}</div>
    <div class="ac">
      <div class="meta">Acceptance criteria (${acComplete}/${acCount} complete)</div>
      <div class="ac-list"></div>
    </div>
    <div class="card-actions">
      <button class="icon-btn" title="Copy story" data-act="copy">ðŸ“‹</button>
      <button class="icon-btn" title="Edit story" data-act="edit">âœŽ</button>
      <button class="icon-btn danger" title="Delete story" data-act="delete">ðŸ—‘</button>
    </div>
  `;

  // AC list
  const acList = el.querySelector('.ac-list');
  card.acceptance.forEach((ac,i)=>{
    const row = document.createElement('div'); row.className='ac-item';
    const tri = document.createElement('div'); tri.className='tri ' + (ac.status||'blank'); tri.title='Click to cycle status';
    tri.onclick = ()=> cycleTri(laneId, colId, card.id, i);
    const tx = document.createElement('div'); tx.className='ac-text'; tx.textContent = ac.text;
    row.appendChild(tri); row.appendChild(tx); acList.appendChild(row);
  });

  // actions
  el.querySelector('[data-act="copy"]').onclick = ()=> copyStory(card);
  el.querySelector('[data-act="edit"]').onclick = ()=> openStoryModal({ laneId, card });
  el.querySelector('[data-act="delete"]').onclick = ()=> deleteStory(laneId, colId, card.id);

  return el;
}

function colLabel(id){
  return id==='backlog'?'Backlog': id==='todo'?'Todo': id==='doing'?'Doing':'Done';
}

// ---- DnD rules ----
function handleDrop({cardId, fromLane, fromCol}, toLane, toCol){
  const card = takeCard(fromLane, fromCol, cardId);
  if(!card){ toast('Error moving card'); return; }
  if(toCol==='todo' && card.acceptance.length===0){ toast('Add at least one acceptance criterion before moving to Todo');
    // put back where it came from
    putCard(fromLane, fromCol, card, /*atEnd*/true);
    render(); return;
  }
  putCard(toLane, toCol, card, /*atEnd*/true);
  save();
}

function takeCard(laneId, colId, cardId){
  const lane = state.find(l=>l.id===laneId); if(!lane) return null;
  const idx = lane.columns[colId].findIndex(c=>c.id===cardId);
  if(idx>-1){ return lane.columns[colId].splice(idx,1)[0]; }
  return null;
}
function putCard(laneId, colId, card, atEnd){
  const lane = state.find(l=>l.id===laneId); if(!lane) return;
  if(atEnd) lane.columns[colId].push(card); else lane.columns[colId].unshift(card);
}

// ---- Modals ----
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const okModal = document.getElementById('okModal');
const cancelModal = document.getElementById('cancelModal');
let modalCtx = null;

function openEpicModal(laneId){
  const lane = state.find(l=>l.id===laneId);
  modalCtx = { type:'epic', laneId };
  modalTitle.textContent = 'Edit Epic';
  modalBody.innerHTML = `
    <div class="field"><label>Epic title</label><input id="epicTitle" value="${escapeAttr(lane.title)}" /></div>
  `;
  okModal.onclick = ()=>{ lane.title = document.getElementById('epicTitle').value.trim()||'Untitled Epic'; save(); closeModal(); };
  openModal();
}

function openStoryModal({ laneId, card }){
  const creating = !card;
  modalCtx = { type:'story', laneId, cardId: card? card.id: null };
  modalTitle.textContent = creating? 'Add Story' : 'Edit Story';
  const vals = card || { title:'', as_a:'', i_want:'', so_that:'', acceptance:[] };
  modalBody.innerHTML = `
    <div class="field"><label>Title</label><input id="stTitle" value="${escapeAttr(vals.title)}" placeholder="User Story: ..."/></div>
    <div class="row">
      <div class="field" style="flex:1"><label>As a</label><input id="stAs" value="${escapeAttr(vals.as_a)}" /></div>
      <div class="field" style="flex:1"><label>I want to</label><input id="stWant" value="${escapeAttr(vals.i_want)}" /></div>
    </div>
    <div class="field"><label>So that</label><input id="stSo" value="${escapeAttr(vals.so_that)}" /></div>
    <div class="field"><label>Acceptance criteria</label>
      <div id="acListEdit"></div>
      <div class="row">
        <input id="acNew" placeholder="Add criterion..." style="flex:1"/>
        <button class="btn" id="acAdd">+ Add</button>
      </div>
      <div class="hint">Click status squares to cycle between blank, partial, complete.</div>
    </div>
  `;
  // build AC list editor
  const acListEdit = modalBody.querySelector('#acListEdit');
  function drawAcEdit(){
    acListEdit.innerHTML = '';
    vals.acceptance.forEach((a,i)=>{
      const row = document.createElement('div'); row.className='ac-item';
      const tri = document.createElement('div'); tri.className='tri '+(a.status||'blank'); tri.onclick=()=>{a.status = nextStatus(a.status||'blank'); drawAcEdit();};
      const tx = document.createElement('input'); tx.className='ac-text'; tx.value=a.text; tx.oninput = (e)=> a.text = e.target.value;
      const del = document.createElement('button'); del.className='icon-btn danger'; del.textContent='ðŸ—‘'; del.title='Remove'; del.onclick=()=>{ vals.acceptance.splice(i,1); drawAcEdit(); };
      row.appendChild(tri); row.appendChild(tx); row.appendChild(del); acListEdit.appendChild(row);
    });
  }
  drawAcEdit();
  modalBody.querySelector('#acAdd').onclick = ()=>{
    const input = modalBody.querySelector('#acNew');
    const t = input.value.trim(); if(!t) return; vals.acceptance.push({text:t, status:'blank'}); input.value=''; drawAcEdit();
  };

  okModal.onclick = ()=>{
    const lane = state.find(l=>l.id===laneId);
    const data = {
      id: creating? makeId('story'): (card.id),
      title: document.getElementById('stTitle').value.trim()||'Untitled Story',
      as_a: document.getElementById('stAs').value.trim(),
      i_want: document.getElementById('stWant').value.trim(),
      so_that: document.getElementById('stSo').value.trim(),
      acceptance: vals.acceptance.filter(a=>a.text.trim())
    };
    if(creating){ lane.columns.backlog.unshift(data); }
    else {
      // find and replace in any column
      for(const c of defaultColumns){
        const idx = lane.columns[c].findIndex(x=>x.id===card.id);
        if(idx>-1){ lane.columns[c][idx] = data; break; }
      }
    }
    save(); closeModal();
  };
  openModal();
}

function openModal(){ modal.classList.add('open'); }
function closeModal(){ modal.classList.remove('open'); modalCtx=null; }
cancelModal.onclick = closeModal;

// ---- Actions: Epics & Stories ----
function addEpic(){
  const id = makeId('epic');
  state.push({ id, title: 'New Epic', columns:{ backlog:[], todo:[], doing:[], done:[] }});
  save();
}
function deleteEpic(laneId){
  if(!confirm('Delete this epic and all its stories?')) return;
  state = state.filter(l=>l.id!==laneId); save();
}
function deleteStory(laneId, colId, cardId){
  const lane = state.find(l=>l.id===laneId); if(!lane) return;
  for(const c of defaultColumns){
    const idx = lane.columns[c].findIndex(x=>x.id===cardId);
    if(idx>-1){ lane.columns[c].splice(idx,1); break; }
  }
  save();
}

function cycleTri(laneId, colId, cardId, i){
  const lane = state.find(l=>l.id===laneId); if(!lane) return;
  const card = lane.columns[colId].find(c=>c.id===cardId); if(!card) return;
  card.acceptance[i].status = nextStatus(card.acceptance[i].status||'blank');
  save();
}
function nextStatus(s){ return s==='blank'? 'partial' : s==='partial'? 'complete' : 'blank'; }

function copyStory(card){
  const text = `Title: ${card.title}\nAs a ${card.as_a}, I want to ${card.i_want}, so that ${card.so_that}\n\nAcceptance criteria:\n` +
    (card.acceptance.length? card.acceptance.map(a=>`- [${a.status==='complete'? 'x': a.status==='partial'? '-':' '}] ${a.text}`).join('\n') : '(none)');
  navigator.clipboard.writeText(text).then(()=> toast('Story copied')).catch(()=> toast('Copy failed'));
}

// ---- Utilities ----
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }
function escapeHtml(s=''){ return s.replace(/[&<>]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]) ); }
function escapeAttr(s=''){ return s.replace(/"/g,'&quot;'); }
function makeId(prefix){ return `${prefix}-` + Math.random().toString(36).slice(2,8); }

// ---- Import from Markdown (optional) ----
// Users can paste markdown; we parse lightweight "### User Story" blocks with acceptance checkboxes
const importBtn = document.getElementById('importMdBtn');
importBtn.onclick = async ()=>{
  const md = await navigator.clipboard.readText().catch(()=>null);
  const text = prompt('Paste project markdown (or will attempt to use clipboard):', md||'');
  if(!text) return;
  try{
    const parsed = parseMarkdown(text);
    if(!parsed.length) throw new Error('No epics found');
    state = seedState(parsed); save(); toast('Imported from markdown');
  } catch(e){ alert('Import failed: '+e.message); }
};

function parseMarkdown(md){
  const lines = md.split(/\r?\n/);
  const epics=[]; let curEpic=null; let curStory=null; let acMode=false;
  function finalizeStory(){ if(curStory){ (curEpic.stories||(curEpic.stories=[])).push(curStory); curStory=null; } }
  function finalizeEpic(){ if(curEpic){ epics.push(curEpic); curEpic=null; } }
  for(const l of lines){
    if(/^\s*##+\s+Epic/i.test(l) || /^\s*##+\s+\d+\./.test(l)){ finalizeStory(); finalizeEpic(); curEpic={ id: makeId('epic'), title: l.replace(/^\s*##+\s+/, '').trim(), stories:[] }; continue; }
    if(/^\s*##+\s+User Story/i.test(l) || /^\s*###\s+User Story/i.test(l)){ finalizeStory(); curStory={ id: makeId('story'), title: l.replace(/^\s*##+\s+/, '').trim(), as_a:'', i_want:'', so_that:'', acceptance:[] }; acMode=false; continue; }
    if(curStory && /Acceptance Criteria/i.test(l)){ acMode=true; continue; }
    if(acMode && /^\s*-\s*\[( |x|-)\]\s*(.+)/i.test(l)){ const m=l.match(/^\s*-\s*\[( |x|-)\]\s*(.+)/i); curStory.acceptance.push({ text:m[2], status: m[1].toLowerCase()==='x'?'complete': m[1]==='-'?'partial':'blank' }); continue; }
    if(curStory && /^\s*\*\*?As a/.test(l)){ curStory.as_a = l.replace(/^\s*\*\*?As a\*\*?\s*/i,'').trim(); continue; }
    if(curStory && /^\s*\*\*?I want to/.test(l)){ curStory.i_want = l.replace(/^\s*\*\*?I want to\*\*?\s*/i,'').trim(); continue; }
    if(curStory && /^\s*\*\*?So that/.test(l)){ curStory.so_that = l.replace(/^\s*\*\*?So that\*\*?\s*/i,'').trim(); continue; }
  }
  finalizeStory(); finalizeEpic();
  return epics;
}

// ---- Top-level controls ----
const saveBtn = document.getElementById('saveBtn');
const addEpicBtn = document.getElementById('addEpicBtn');
saveBtn.onclick = save; addEpicBtn.onclick = addEpic;

// Kick off
render();
</script>

<script>
// Inject parsed JSON from the server-side (assistant) below
</script>
</body>
</html>
