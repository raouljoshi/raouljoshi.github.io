<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EALF Estonia Visit • Sept 16–20, 2025</title>
<meta name="theme-color" content="#0f172a" />
<style>
  :root{
    --bg:#0b1222;
    --card:#121a2e;
    --muted:#8ea0c2;
    --text:#e6ecff;
    --accent:#65d1ff;
    --accent-2:#aef39d;
    --warning:#ffd166;
    --danger:#ff758f;
    --ok:#7ef0c1;
    --chip:#1b2743;
    --border:#223055;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:860px;margin:0 auto;padding:12px 12px 80px}
  header{
    position:sticky;top:0;z-index:10;
    background:linear-gradient(180deg,#0b1222 70%,#0b122200);
    padding:10px 0 8px
  }
  .title{display:flex;gap:8px;align-items:center}
  .title h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
  .subtitle{color:var(--muted);font-size:12px;margin-top:2px}
  .tabs{display:flex;gap:6px;overflow:auto;padding:10px 2px 2px}
  .chip{
    white-space:nowrap;border:1px solid var(--border);
    background:var(--chip);color:var(--text);
    padding:8px 10px;border-radius:999px;font-size:13px
  }
  .chip[aria-selected="true"]{background:var(--accent);color:#04121a;border-color:transparent;font-weight:700}
  .controls{display:flex;gap:8px;margin:8px 0 2px}
  .btn{
    flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;
    background:#102041;border:1px solid var(--border);color:var(--text);
    padding:10px 12px;border-radius:10px;font-size:14px
  }
  .btn.secondary{background:#0f1a35}
  .btn:active{transform:translateY(1px)}
  .search{position:relative; margin:10px 0 0}
  .search input{
    width:100%;padding:12px 14px 12px 38px;border-radius:10px;border:1px solid var(--border);
    background:#0f1a35;color:var(--text);font-size:14px
  }
  .search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.7}
  .day{margin-top:10px}
  .date-label{
    position:sticky;top:66px;z-index:5;
    font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em;
    padding:6px 2px;background:#0b1222d9;backdrop-filter:saturate(150%) blur(6px)
  }
  .card{
    background:var(--card);border:1px solid var(--border);
    border-radius:14px;padding:12px;margin:10px 0
  }
  .row{display:flex;gap:12px}
  .time{
    flex:0 0 78px;font-weight:700;color:#e9f4ff;font-size:13px;letter-spacing:.2px
  }
  .body{flex:1;min-width:0}
  .h{margin:0 0 3px;font-size:15px;font-weight:750}
  .loc, .speakers, .note{font-size:13px;color:var(--muted);margin:2px 0}
  .badge{display:inline-flex;gap:6px;align-items:center;background:#0e2441;border:1px solid var(--border);color:#cfe3ff;border-radius:999px;padding:4px 8px;font-size:12px}
  .when-now{border-color:transparent;background:linear-gradient(90deg,#65d1ff33,#aef39d33);}
  .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tool{
    display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:8px;
    border:1px solid var(--border);background:#0f1a35;color:var(--text);font-size:13px
  }
  .tool:active{transform:translateY(1px)}
  .empty{color:var(--muted);text-align:center;padding:22px 8px}
  .divider{height:1px;background:var(--border);margin:14px 0}
  /* bottom nav */
  .nav{
    position:fixed;inset:auto 0 0 0;background:#0b1222f2;border-top:1px solid var(--border);
    display:flex;gap:8px;justify-content:space-around;padding:10px 8px;backdrop-filter:blur(6px)
  }
  .nav button{
    flex:1;background:#0f1a35;border:1px solid var(--border);color:var(--text);padding:10px;border-radius:12px;font-size:12px
  }
  .nav button[aria-current="page"]{background:var(--accent);color:#03141b;border-color:transparent;font-weight:800}
  /* sections */
  section{display:none}
  section.active{display:block}
  ul.clean{list-style:none;margin:0;padding:0}
  li.item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0}
  .grid{display:grid;grid-template-columns:minmax(0,1fr);gap:8px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0e2441;border:1px solid var(--border);font-size:12px;color:#cfe3ff}
  .links a{display:inline-flex;align-items:center;gap:8px;margin-right:12px;margin-top:8px}
  @media (min-width:720px){
    .row{gap:16px}
    .time{flex-basis:100px}
    .wrap{padding-bottom:100px}
    .grid{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 19c3-1 6-1 8-6 2 5 5 5 8 6-2 2-5 3-8 3s-6-1-8-3Z" stroke="#65d1ff" stroke-width="1.5" />
          <circle cx="12" cy="7" r="3.2" stroke="#aef39d" stroke-width="1.5"/>
        </svg>
        <h1>EALF Learning Trip • Estonia</h1>
      </div>
      <div class="subtitle">Tallinn • Sept 16–20, 2025</div>

      <div class="tabs" id="dayTabs" role="tablist" aria-label="Days"></div>

      <div class="controls">
        <button class="btn" id="btnNow" title="Jump to current/next item">What's on now</button>
        <button class="btn secondary" id="btnMyPlan" title="See items you starred">My plan (★)</button>
      </div>

      <label class="search" aria-label="Search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="11" cy="11" r="7.5" stroke="#8ea0c2" stroke-width="1.6"/>
          <path d="M20 20l-3.5-3.5" stroke="#8ea0c2" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
        <input id="search" type="search" placeholder="Search title, location, speaker…" />
      </label>
    </header>

    <!-- Schedule -->
    <section id="scheduleSection" class="active" aria-labelledby="schedule-tab">
      <div id="schedule"></div>
    </section>

    <!-- Logistics -->
    <section id="logisticsSection" aria-labelledby="logistics-tab">
      <h2>Logistics & Practical Info</h2>
      <div class="grid">
        <div class="card">
          <h3 class="h">Objectives</h3>
          <ul class="clean">
            <li>• Strengthen group cohesion among EALF alumni.</li>
            <li>• Learn from Estonian education stakeholders and systems.</li>
            <li>• Reflect to improve impact back home.</li>
          </ul>
        </div>
        <div class="card">
          <h3 class="h">Transport</h3>
          <p class="note">Tallinn is walkable. Public transport tickets cost €2 and are valid for 1 hour (buy with contactless on board — enter at the first door). We'll use cars for visits outside Tallinn.</p>
          <div class="links">
            <a href="https://maps.app.goo.gl/sUiXkVguAwUCG3Eo7" target="_blank" rel="noopener">Tallinn Airport (TLL)</a>
          </div>
        </div>
        <div class="card">
          <h3 class="h">Accommodation</h3>
          <p class="note">Airbnbs ~€40–50 pp/night; hotels: Citybox, Hampton by Hilton, Nordic Hotel Forum. Look for a place with a sauna for a cultural bonus.</p>
        </div>
        <div class="card">
          <h3 class="h">Meals & Budget</h3>
          <p class="note">Participants cover meals except Friday dinner (Teach For All). School lunch &lt; €5. Mid-range meals: soup €7–9, salad €9–11, mains €10–20, beer €6–7.</p>
        </div>
        <div class="card">
          <h3 class="h">Weather & Dress</h3>
          <p class="note">Expect 10–15°C and possible rain. Dress business-casual for Wed/Thu meetings. For school visits, bring indoor shoes/slippers.</p>
        </div>
        <div class="card">
          <h3 class="h">Good to Know</h3>
          <ul class="clean">
            <li>• Currency: Euro; cards widely accepted.</li>
            <li>• Tap water is safe.</li>
            <li>• Tallinn is generally safe — use normal precautions.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Contacts -->
    <section id="contactsSection" aria-labelledby="contacts-tab">
      <h2>Contacts</h2>
      <div class="card">
        <div class="row">
          <div class="body">
            <div class="h">Sandra Fomotškin <span class="pill">Main organizer</span></div>
            <div class="loc">📧 <a href="mailto:sandra.fomotskin@gmail.com">sandra.fomotskin@gmail.com</a></div>
            <div class="loc">📱 <a href="tel:+37256246806">+372 5624 6806</a></div>
            <p class="note">If you need an invitation letter, official program, or certificate for your employer/visa, contact Sandra.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Pre-reads -->
    <section id="prereadsSection" aria-labelledby="prereads-tab">
      <h2>Pre-readings & Videos</h2>
      <ul class="clean">
        <li class="item">
          <div class="h">About Estonia</div>
          <div class="links">
            <a href="https://estonia.ee/" target="_blank" rel="noopener">estonia.ee</a>
          </div>
        </li>
        <li class="item">
          <div class="h">Estonian education system</div>
          <div class="links">
            <a href="https://www.youtube.com/@EducationEstonia" target="_blank" rel="noopener">EducationEstonia (YouTube)</a>
            <a href="https://www.educationestonia.org/wp-content/uploads/2023/12/AimHighEstoniaCaseStudy.pdf" target="_blank" rel="noopener">Estonia Case Study (PDF)</a>
          </div>
        </li>
        <li class="item">
          <div class="h">Tallinn guide</div>
          <div class="links">
            <a href="https://www.lonelyplanet.com/articles/guide-to-tallinn" target="_blank" rel="noopener">Lonely Planet: First-time Tallinn</a>
          </div>
        </li>
      </ul>
    </section>
  </div>

  <nav class="nav" role="navigation" aria-label="Primary">
    <button id="navSchedule" aria-current="page">Schedule</button>
    <button id="navLogistics">Logistics</button>
    <button id="navContacts">Contacts</button>
    <button id="navPrereads">Pre-reads</button>
  </nav>

<script>
/* ===========
   DATA
   =========== */
const tz = "Europe/Tallinn"; // local timezone for events
// Helper to make map links
const gmap = (addr) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;

// Event schema:
// { id, day: "2025-09-16", start:"19:00", end:"", title, location, address, speakers:[], notes:"", tags:[] }
const EVENTS = [
  // Tue 16 Sep
  {
    id: "arrive",
    day: "2025-09-16", start: "15:00", end: "", title: "Arrivals & check-in",
    location: "Tallinn Airport / City",
    address: "Tallinn Airport (TLL)",
    notes: "Airport ~15–30 min from city; Bus €2; Bolt €10–15",
    tags:["travel"]
  },
  {
    id: "tue-dinner",
    day: "2025-09-16", start: "19:00", end: "", title: "Welcome dinner",
    location: "Apartment or nearby",
    address: "Tallinn Old Town",
    notes: "Optional short old town tour afterwards",
    tags:["social","food"]
  },

  // Wed 17 Sep — Big Picture
  {
    id: "wed-breakfast",
    day: "2025-09-17", start: "08:00", end: "08:45", title: "Optional breakfast meeting",
    location: "Dot Cafe", address: "Dot Cafe, Tallinn", notes:"Wear comfortable shoes; be ready to buy a tram/bus ticket",
    tags:["meet"]
  },
  {
    id: "wed-ministry",
    day: "2025-09-17", start: "09:00", end: "10:30",
    title: "Structure of Estonian Education, ‘Recipe’ for Success & AI Leap",
    location: "Ministry of Education", address: "Tõnismägi 11, Tallinn",
    speakers:[
      "Riin Saadjärv (Head of EdTech Area)",
      "Sandra Fomotškin (Advisor on Inclusive Education; former Chief Analyst)"
    ],
    notes:"Arrive a few minutes early for security.",
    tags:["session","policy"]
  },
  {
    id: "wed-tlu",
    day: "2025-09-17", start: "11:00", end: "12:30",
    title: "Teacher training & policy; Research-based decision-making",
    location: "Tallinn University", address: "Narva mnt 25, Tallinn",
    speakers:[
      "Kristi Klaasmägi (Vice-Rector for Educational Innovation; ex-CEO Noored Kooli)",
      "Joosep Norma (Tallinn University; Noored Kooli alumnus & trainer)"
    ],
    tags:["session","university"]
  },
  {
    id: "wed-lunch",
    day: "2025-09-17", start: "12:30", end: "13:15",
    title: "Lunch",
    location: "University cafeteria / Ülemiste City", address: "Narva mnt 25, Tallinn / Ülemiste City",
    tags:["food"]
  },
  {
    id: "wed-nk",
    day: "2025-09-17", start: "13:45", end: "14:45",
    title: "Meeting with Triin Noorkõiv + Reflection",
    location: "Noored Kooli office", address: "Lõõtsa 8, Tallinn",
    speakers:["Triin Noorkõiv (Back to School; School for New Teachers; Clanbeat)"],
    tags:["session","alumni"]
  },
  {
    id: "wed-eestonia",
    day: "2025-09-17", start: "15:00", end: "16:30",
    title: "e-Estonia Briefing Centre — e-services & why they matter",
    location: "e-Estonia Briefing Centre", address: "Valukoja 8, Tallinn",
    tags:["visit","digital"]
  },
  { id:"wed-free", day:"2025-09-17", start:"17:00", end:"", title:"Free time & dinner", location:"—", address:"Tallinn", tags:["free","food"] },

  // Thu 18 Sep — Grassroots
  {
    id:"thu-drive-saku", day:"2025-09-18", start:"08:30", end:"", title:"Drive to Saku", location:"Meeting spot TBC", address:"Saku, Harju County", notes:"Municipality next to Tallinn (Sandra lives here).", tags:["travel"]
  },
  {
    id:"thu-kinder", day:"2025-09-18", start:"09:00", end:"10:00",
    title:"Visit: Kindergarten Päikesekild", location:"Päikesekild Kindergarten", address:"Teaduse 14, Saku",
    tags:["school","visit","early-years"]
  },
  {
    id:"thu-saku-gym", day:"2025-09-18", start:"10:30", end:"12:30",
    title:"Visit: Saku Gymnasium", location:"Saku Gymnasium", address:"Traani tee 1, Saku",
    tags:["school","visit"]
  },
  {
    id:"thu-lunch", day:"2025-09-18", start:"12:30", end:"13:15",
    title:"School lunch", location:"At school cafeteria", address:"Traani tee 1, Saku", tags:["food"]
  },
  {
    id:"thu-lgov", day:"2025-09-18", start:"13:30", end:"14:30",
    title:"Local government: driving change via collective leadership",
    location:"Municipality / school", address:"Juubelitammede tee 15, Saku (or at school)",
    tags:["policy","session"]
  },
  {
    id:"thu-drive-back", day:"2025-09-18", start:"14:45", end:"15:30",
    title:"Drive back to Tallinn / to Laulasmaa", location:"—", address:"Tallinn or Laulasmaa", tags:["travel"]
  },
  {
    id:"thu-ail", day:"2025-09-18", start:"15:30", end:"",
    title:"AI Leap: meeting with COO Laura Kalda",
    location:"Telliskivi Creative City", address:"Telliskivi 60-5, Tallinn", tags:["session","AI"]
  },
  {
    id:"thu-or-laulasmaa", day:"2025-09-18", start:"15:30", end:"",
    title:"OR: Join EALF 3rd cohort session (Laulasmaa)",
    location:"Arvo Pärt Centre (Laulasmaa)", address:"Arvo Pärdi keskus, Kellasalu tee 3, Laulasmaa",
    tags:["session","music","optional"]
  },
  {
    id:"thu-free", day:"2025-09-18", start:"18:00", end:"",
    title:"Free time & dinner", location:"Tallinn / Laulasmaa", address:"—", notes:"There’s a spa in Laulasmaa…", tags:["free","food"]
  },

  // Fri 19 Sep — Narva & reform
  {
    id:"fri-start", day:"2025-09-19", start:"07:30", end:"",
    title:"Start to Narva", location:"Meet spot TBC", address:"Narva (Russian border town)", notes:"Learn how politics ties into Estonian education; Estonian-language instruction in a mostly Russian-speaking town.", tags:["travel"]
  },
  {
    id:"fri-school", day:"2025-09-19", start:"10:00", end:"12:00",
    title:"Visit: Narva Eesti Gymnasium", location:"Hariduse 3, Narva", address:"Hariduse 3, Narva",
    notes:"Fellow Liina Punamäe (EALF 3rd cohort) works here.",
    tags:["school","visit"]
  },
  {
    id:"fri-lunch", day:"2025-09-19", start:"12:00", end:"12:30",
    title:"School lunch", location:"On site", address:"Hariduse 3, Narva", tags:["food"]
  },
  {
    id:"fri-tour", day:"2025-09-19", start:"12:30", end:"13:30",
    title:"Narva tour", location:"Narva", address:"Narva Town", tags:["tour"]
  },
  { id:"fri-drive-johvi", day:"2025-09-19", start:"13:45", end:"15:00", title:"Drive to Jõhvi", location:"—", address:"Jõhvi", tags:["travel"] },
  {
    id:"fri-kood", day:"2025-09-19", start:"15:00", end:"16:00",
    title:"Visit: kood/Jõhvi (TBC)", location:"kood/Jõhvi", address:"Tartu põik 5, Jõhvi", tags:["visit","tech"]
  },
  { id:"fri-drive-back", day:"2025-09-19", start:"16:00", end:"18:00", title:"Drive back to Tallinn", location:"—", address:"Tallinn", tags:["travel"] },
  {
    id:"fri-dinner", day:"2025-09-19", start:"18:00", end:"", title:"Community gathering & dinner (with EALF 3rd cohort & Noored Kooli alumni)",
    location:"Mona’s place", address:"Tatari 21b, Tallinn", notes:"Dinner covered by Teach For All", tags:["social","food"]
  },

  // Sat 20 Sep — Explore
  {
    id:"sat-explore", day:"2025-09-20", start:"10:00", end:"",
    title:"Explore Tallinn (free tour & ideas)", location:"Tallinn", address:"Old Town, Telliskivi, Kadriorg…", tags:["free","tour"]
  },
  {
    id:"sat-depart", day:"2025-09-20", start:"16:00", end:"",
    title:"Departures from Tallinn", location:"Tallinn Airport (TLL)", address:"Tallinn Airport (TLL)", tags:["travel"]
  }
];

/* ===========
   RENDER
   =========== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

const scheduleEl = $('#schedule');
const tabsEl = $('#dayTabs');
const searchEl = $('#search');

const DAYS = Array.from(new Set(EVENTS.map(ev=>ev.day))).sort();
let activeDay = DAYS[0];
let showOnlyStarred = false;

function formatDateLabel(iso){
  const d = new Date(iso+'T00:00:00');
  return d.toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'});
}
function toDateTime(day, timeStr){
  // timeStr may be "" (open-ended)
  const [h,m] = (timeStr||"00:00").split(":").map(Number);
  const dt = new Date(`${day}T${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`);
  return dt;
}
function nowInTZ(tz){
  // Using Intl to get local-equivalent time in TZ
  const now = new Date();
  const fmt = new Intl.DateTimeFormat('en-US',{timeZone:tz, hour12:false,
    year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'
  });
  const parts = Object.fromEntries(fmt.formatToParts(now).map(p=>[p.type,p.value]));
  return new Date(`${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}`);
}
const stars = new Set(JSON.parse(localStorage.getItem('stars')||'[]'));

function renderTabs(){
  tabsEl.innerHTML = '';
  DAYS.forEach(day=>{
    const btn = document.createElement('button');
    btn.className = 'chip';
    btn.type = 'button';
    btn.setAttribute('role','tab');
    btn.setAttribute('aria-selected', day===activeDay ? 'true':'false');
    btn.textContent = new Date(day).toLocaleDateString(undefined,{weekday:'long', month:'short', day:'numeric'});
    btn.addEventListener('click', ()=>{activeDay=day; renderSchedule(); scrollToTop();});
    tabsEl.appendChild(btn);
  });
}

function matchesQuery(ev, q){
  if(!q) return true;
  q = q.toLowerCase();
  const texts = [
    ev.title, ev.location, ev.address, ev.notes || '',
    ...(ev.speakers||[])
  ].join(' ').toLowerCase();
  return texts.includes(q);
}

function renderSchedule(){
  renderTabs();
  const q = searchEl.value.trim();
  const dayEvents = EVENTS
    .filter(ev=>ev.day===activeDay)
    .filter(ev=>matchesQuery(ev,q))
    .filter(ev=>!showOnlyStarred || stars.has(ev.id))
    .sort((a,b)=> (a.start||'') < (b.start||'') ? -1 : 1);

  scheduleEl.innerHTML = '';
  const dateLabel = document.createElement('div');
  dateLabel.className = 'date-label';
  dateLabel.textContent = new Date(activeDay).toLocaleDateString(undefined,{weekday:'long', month:'long', day:'numeric'});
  scheduleEl.appendChild(dateLabel);

  if(!dayEvents.length){
    const empty = document.createElement('div');
    empty.className = 'empty';
    empty.textContent = showOnlyStarred ? 'No starred items this day.' : 'No items match your search.';
    scheduleEl.appendChild(empty);
    return;
  }

  const now = nowInTZ(tz);

  for(const ev of dayEvents){
    const card = document.createElement('div');
    card.className = 'card';

    const row = document.createElement('div');
    row.className = 'row';

    const time = document.createElement('div');
    time.className = 'time';
    time.textContent = ev.start ? (ev.end ? `${ev.start}–${ev.end}` : ev.start) : '—';

    const body = document.createElement('div'); body.className='body';

    const h = document.createElement('div'); h.className='h'; h.textContent = ev.title;

    const line2 = document.createElement('div'); line2.className='loc';
    line2.innerHTML = `📍 ${ev.location}${ev.address && ev.address!=='—' ? ` — <a href="${gmap(ev.address)}" target="_blank" rel="noopener">Maps</a>`:''}`;

    const speakers = (ev.speakers && ev.speakers.length) ? (()=> {
      const el = document.createElement('div'); el.className='speakers';
      el.textContent = `👥 ${ev.speakers.join(' · ')}`;
      return el;
    })() : null;

    const note = ev.notes ? (()=> {
      const el = document.createElement('div'); el.className='note'; el.textContent = ev.notes;
      return el;
    })() : null;

    // timing badge (now/next)
    const badge = document.createElement('span'); badge.className='badge';
    const start = ev.start ? toDateTime(ev.day, ev.start) : null;
    const end = ev.end ? toDateTime(ev.day, ev.end) : null;
    let state = '';
    if(start && now < start){ state = 'Upcoming'; }
    if(start && end && now >= start && now <= end){ state = 'Happening now'; badge.classList.add('when-now'); }
    if(start && end && now > end){ state = 'Ended'; }
    if(!start){ state = 'Anytime'; }
    badge.textContent = state || '—';

    // tools
    const tools = document.createElement('div'); tools.className='tools';

    const btnMap = document.createElement('button'); btnMap.className='tool';
    btnMap.innerHTML = '🗺️ Open map';
    btnMap.addEventListener('click',()=> window.open(gmap(ev.address || ev.location), '_blank','noopener'));

    const btnCopy = document.createElement('button'); btnCopy.className='tool';
    btnCopy.textContent = '📋 Copy address';
    btnCopy.addEventListener('click', async ()=>{
      const text = `${ev.location}${ev.address && ev.address!=='—' ? ', '+ev.address : ''}`;
      try{ await navigator.clipboard.writeText(text); btnCopy.textContent='✅ Copied'; setTimeout(()=>btnCopy.textContent='📋 Copy address',1200);}catch(e){ alert(text); }
    });

    const btnICS = document.createElement('button'); btnICS.className='tool';
    btnICS.textContent = '📅 Add to calendar';
    btnICS.addEventListener('click', ()=>downloadICS(ev));

    const btnStar = document.createElement('button'); btnStar.className='tool';
    function setStarText(){ btnStar.textContent = stars.has(ev.id) ? '★ Starred' : '☆ Star'; }
    setStarText();
    btnStar.addEventListener('click', ()=>{
      if(stars.has(ev.id)) stars.delete(ev.id); else stars.add(ev.id);
      localStorage.setItem('stars', JSON.stringify(Array.from(stars)));
      setStarText();
    });

    // assemble
    body.appendChild(h);
    body.appendChild(badge);
    body.appendChild(line2);
    if(speakers) body.appendChild(speakers);
    if(note) body.appendChild(note);

    tools.appendChild(btnMap);
    tools.appendChild(btnCopy);
    tools.appendChild(btnICS);
    tools.appendChild(btnStar);

    row.appendChild(time);
    row.appendChild(body);
    card.appendChild(row);
    card.appendChild(tools);
    scheduleEl.appendChild(card);
  }
}

function scrollToTop(){ window.scrollTo({top:0, behavior:'smooth'}); }

// ICS download
function pad(n){ return String(n).padStart(2,'0'); }
function toICSDate(dt){
  // returns YYYYMMDDTHHMMSSZ in UTC
  const u = new Date(dt.getTime() - dt.getTimezoneOffset()*60000);
  return u.getUTCFullYear()
  + pad(u.getUTCMonth()+1)
  + pad(u.getUTCDate()) + 'T'
  + pad(u.getUTCHours())
  + pad(u.getUTCMinutes())
  + pad(u.getUTCSeconds()) + 'Z';
}
function downloadICS(ev){
  const start = ev.start ? toDateTime(ev.day, ev.start) : toDateTime(ev.day,"09:00");
  const end = ev.end ? toDateTime(ev.day, ev.end) : toDateTime(ev.day,"10:00");
  const uid = `${ev.id}@ealf-estonia`;
  const summary = ev.title;
  const location = `${ev.location}${ev.address && ev.address!=='—' ? ', '+ev.address : ''}`;
  const desc = (ev.notes || '') + (ev.speakers?.length ? `\nSpeakers: ${ev.speakers.join('; ')}` : '');
  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//EALF//EstoniaTrip//EN
CALSCALE:GREGORIAN
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${toICSDate(new Date())}
DTSTART:${toICSDate(start)}
DTEND:${toICSDate(end)}
SUMMARY:${summary.replace(/\n/g,' ')}
LOCATION:${location.replace(/\n/g,' ')}
DESCRIPTION:${desc.replace(/\n/g,' ')}
END:VEVENT
END:VCALENDAR`;
  const blob = new Blob([ics], {type:'text/calendar'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${ev.day}-${ev.id}.ics`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

// Search & filters
searchEl.addEventListener('input', ()=>renderSchedule());
$('#btnMyPlan').addEventListener('click', ()=>{
  showOnlyStarred = !showOnlyStarred;
  $('#btnMyPlan').setAttribute('aria-pressed', showOnlyStarred ? 'true' : 'false');
  $('#btnMyPlan').textContent = showOnlyStarred ? 'My plan (showing ★)' : 'My plan (★)';
  renderSchedule();
});

// What's on now
$('#btnNow').addEventListener('click', ()=>{
  // Find the first event that's ongoing or next today (in Tallinn time). If none today, switch to closest day with future events.
  const now = nowInTZ(tz);
  // search same day first
  const candidates = EVENTS.filter(e=>e.day===activeDay)
    .map(e=>({e, s: e.start?toDateTime(e.day,e.start):null, en: e.end?toDateTime(e.day,e.end):null}))
    .sort((a,b)=>(a.s||Infinity)-(b.s||Infinity));
  let targetId = null;
  for(const c of candidates){
    if(c.s && c.en && now>=c.s && now<=c.en){ targetId=c.e.id; break; }
    if(c.s && now<c.s && !targetId){ targetId=c.e.id; }
  }
  if(!targetId){
    // fallback: next day with future item
    const after = EVENTS
      .map(e=>({e, s: e.start?toDateTime(e.day,e.start):toDateTime(e.day,"23:59")}))
      .filter(o=>o.s>now)
      .sort((a,b)=>a.s-b.s)[0];
    if(after){ activeDay = after.e.day; renderSchedule(); targetId = after.e.id; }
  }
  if(targetId){
    const el = scheduleEl.querySelector(`[data-id="${targetId}"]`) || Array.from(scheduleEl.querySelectorAll('.card'))[0];
    el?.scrollIntoView({behavior:'smooth', block:'center'});
  } else {
    // nothing upcoming — jump to last day
    activeDay = DAYS[DAYS.length-1]; renderSchedule();
  }
});

// Bottom nav
const sections = {
  schedule: $('#scheduleSection'),
  logistics: $('#logisticsSection'),
  contacts: $('#contactsSection'),
  prereads: $('#prereadsSection')
};
function setPage(page){
  for(const [key,sec] of Object.entries(sections)){ sec.classList.toggle('active', key===page); }
  $('#navSchedule').setAttribute('aria-current', page==='schedule'?'page':null);
  $('#navLogistics').setAttribute('aria-current', page==='logistics'?'page':null);
  $('#navContacts').setAttribute('aria-current', page==='contacts'?'page':null);
  $('#navPrereads').setAttribute('aria-current', page==='prereads'?'page':null);
  if(page==='schedule'){ scrollToTop(); }
}
$('#navSchedule').addEventListener('click',()=>setPage('schedule'));
$('#navLogistics').addEventListener('click',()=>setPage('logistics'));
$('#navContacts').addEventListener('click',()=>setPage('contacts'));
$('#navPrereads').addEventListener('click',()=>setPage('prereads'));

// Initial render
(function init(){
  // add data-id hooks after render
  const _render = renderSchedule;
  renderSchedule = function(){
    _render();
    // add data-id to cards in order
    const dayEvents = EVENTS.filter(e=>e.day===activeDay).sort((a,b)=> (a.start||'') < (b.start||'') ? -1 : 1);
    const cards = $$('.card', scheduleEl);
    cards.forEach((c,i)=> c.setAttribute('data-id', dayEvents[i]?.id || ''));
  }
  renderSchedule();
})();
</script>
</body>
</html>
